---
title: "13CO2_partitioning"
author: "Greg McKittrick"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Load necessary library
library(ggplot2)
library(tidyverse)
library(readxl)
library(dplyr)
library(lme4)
library(lmerTest)
library(pbkrtest)
library(emmeans)
```

## Set output directory value

```{r}
# Get current date
current_date <- Sys.Date()

# Format date as yyyy-mm-dd
date_string <- format(current_date, "%Y-%m-%d")

# Create output folder path
output_folder <- paste0("../Output/", date_string, "/")
```

## Read in Data

```{r}
# load in 13C data from GHG-IRMS
C13Data <- read_excel("../GHG-IRMS/GHG-IRMS-All-Data.xlsx", sheet = 1)

C13Data <- C13Data %>%
  rename(CO2_delta_13C_VPDB = `CO2 δ¹³C (VPDB)`) %>% 
  na.omit()

# Convert variables to appropriate types
C13Data$Jar <- as.factor(C13Data$Jar)
C13Data$Rep <- as.factor(C13Data$Rep)
#allData$Day <- as.factor(allData$Day)
C13Data$Treatment <- as.factor(C13Data$Treatment)
C13Data$Case <- paste(C13Data$Treatment, C13Data$Rep, sep = "_")
C13Data$Case <- as.factor(C13Data$Case)
str(C13Data)
```

## Filter out bad observations due to techinical issues (leaky lids)

```{r}

# Step 1: Filter out specific Case for days 14, and 17, 22, 30
#once one has been removed, all measuremnt for that jar on subsequent days need to be removed because cumulative_ugCO2_C_gdried_soil will be falsely low at those points without consideration of the missing one before it
C13Data_filtered <- C13Data %>%
  filter(!(Day %in% c("14", "17", "22","30","37") & Case == "BSA_1"))

# Step 1: Filter out specific Case for day 30
C13Data_filtered <- C13Data_filtered %>%
  filter(!(Day %in% c("30","37") & Case == "Ure2_2"))
```

##Read in Setup details with substrate weights, substrate delta C13, and soil weight

```{r}
SetupDetails <- read_excel("../SetupDetails.xlsx", sheet = 1)

SetupDetails$Jar <- as.factor(SetupDetails$Jar)
SetupDetails <- SetupDetails %>%
  rename(substrate_C_added_ug = `amount C-added (ug)`,
         dried_soil_g = `dried soil (g)`,
         delta_C13_substrates = `Delta C13 Substrates`)

# Convert variables to appropriate types
SetupDetails$Jar <- as.factor(SetupDetails$Jar)
SetupDetails$Rep <- as.factor(SetupDetails$Rep)
#allData$Day <- as.factor(allData$Day)
SetupDetails$Treatment <- as.factor(SetupDetails$Treatment)
```

##Add set up details to C13Data_filtered

```{r}
C13Data_filtered <- C13Data_filtered %>% left_join(SetupDetails, by = "Jar", suffix = c("", "")) %>%
  select(Jar, Case, Day, Rep, Treatment,CO2_delta_13C_VPDB, substrate_C_added_ug, delta_C13_substrates, dried_soil_g)
```

## Read in "cumulativeData_CO2_C.csv" from Cumulative_CO2_C.rmd

```{r}
cumulativeData_CO2_C <- read.csv(file = paste0 (output_folder, "cumulativeData_CO2_C.csv"))

# Convert variables to appropriate types
cumulativeData_CO2_C$Jar <- as.factor(cumulativeData_CO2_C$Jar)
cumulativeData_CO2_C$Rep <- as.factor(cumulativeData_CO2_C$Rep)
#allData$Day <- as.factor(allData$Day)
cumulativeData_CO2_C$Treatment <- as.factor(cumulativeData_CO2_C$Treatment)
cumulativeData_CO2_C$Case <- as.factor(cumulativeData_CO2_C$Case)
cumulativeData_CO2_C$Day <- as.numeric(cumulativeData_CO2_C$Day)
str(cumulativeData_CO2_C)
```

## Add cumulative CO2 data to C13_Data_filtered

```{r}
C13Data_filtered <- C13Data_filtered %>% 
  left_join(cumulativeData_CO2_C, by = c("Treatment", "Day", "Rep", "Case", "Jar"), suffix = c("",""))%>%
  select(Jar, Case, Day, Rep, Treatment,CO2_delta_13C_VPDB, substrate_C_added_ug, delta_C13_substrates, dried_soil_g, ugCO2_C_per_gdried_soil, cumulative_ugCO2_C_per_gdried_soil)
```


## Calculate daily soil-only average

```{r}

#Calculate daily soil only average delta 13C CO2
daily_soil_only <- C13Data_filtered %>% 
  filter(Treatment == "Soil Only") %>% 
  group_by(Day) %>% 
  summarise(daily_soil_only_mean_CO2_delta_13C_VPDB = mean(CO2_delta_13C_VPDB))

#Calculate soil only average delta 13C CO2 from whole experiment
all_soil_only <- C13Data_filtered %>% 
  filter(Treatment == "Soil Only") %>% 
  summarise(all_soil_only_mean_CO2_delta_13C_VPDB = mean(CO2_delta_13C_VPDB))

# Merge daily_soil_only_mean into filtered_merged_data
C13Data_filtered <- C13Data_filtered %>%
  left_join(daily_soil_only, by = "Day")

```

## calculate proportion_substrate_respiration

```{r}

C13Data_filtered <- C13Data_filtered %>% 
  mutate(proportion_substrate_respiration = ((CO2_delta_13C_VPDB - daily_soil_only_mean_CO2_delta_13C_VPDB)/(delta_C13_substrates - daily_soil_only_mean_CO2_delta_13C_VPDB)))

#create a new column called final_proportion_substrate_respiration where if the value of prop_13C_respired is < 0, the final_prop_13C_respired becomes 0, or if the value of prop_13C_respired is > 1, the final_prop_13C_respired becomes 1, and if neither it just stays the same as prop_13C_respired
C13Data_filtered <- C13Data_filtered %>%
  mutate(final_proportion_substrate_respiration = case_when(
    is.na(proportion_substrate_respiration) ~ 0,  # If prop_13C_respired is NA, set final_prop_13C_respired to 0, this is the case for soil only
    proportion_substrate_respiration < 0 ~ 0,
    proportion_substrate_respiration > 1 ~ 1,
    TRUE ~ proportion_substrate_respiration
  ))

#write.csv(proportion_13C, "proportion_13C.csv")
```

## Calculate substrate respired (ugCO2-C /g dried soil) and soil respired (ugCO2-C /g dried soil)

```{r}
C13Data_filtered <- C13Data_filtered %>% 
  mutate(respired_substrate_ugCO2_C_per_gdried_soil = final_proportion_substrate_respiration * ugCO2_C_per_gdried_soil,
         soil_respired_ugCO2_C_per_gdried_soil = ugCO2_C_per_gdried_soil - respired_substrate_ugCO2_C_per_gdried_soil)
```

##Calculate C rates added (ugC/g dried soil) and 13C respired % then cumulative percent 13C repsired

```{r,fig.show='plot}

C13Data_filtered <- C13Data_filtered %>% 
  mutate(ug_C_per_g_dried_soil = substrate_C_added_ug / dried_soil_g,
         percent_substrate_respired = (respired_substrate_ugCO2_C_per_gdried_soil / ug_C_per_g_dried_soil )*100) %>% 
  group_by(Treatment,Rep) %>% 
  mutate(cumulative_percent_substrate_respired = cumsum(percent_substrate_respired)) %>% 
  arrange(Treatment, Rep)

#Save this final dataset and transformaitons as CSV

write.csv(C13Data_filtered, paste0(output_folder, "13CO2_partitioning.csv"))
```

## Create a summary of 13CO2_partitioning.csv where reps are averaged

```{r}
summary_C13Data_filtered <- C13Data_filtered %>%
  group_by(Treatment,Day) %>% 
  summarize(n = n(),
            avg_cumulative_percent_substrate_respired = mean(cumulative_percent_substrate_respired),
         st_dev = sd(cumulative_percent_substrate_respired),
            .groups = 'drop') %>% 
  group_by(Treatment) %>%
  mutate(cumulative_stdDev = sqrt(cumsum(st_dev^2))) %>% 
  arrange(Treatment)


#write this summary to a csv file

write.csv(summary_C13Data_filtered, paste0(output_folder, "summary_13CO2_partitioning.csv"))
```

## Plot cumulative_percent_substrate_respired (no averaging of reps)

```{r}
# plot cumulative_percent_13C_respired

p <- ggplot(C13Data_filtered, aes(x = Day, y = cumulative_percent_substrate_respired, color = Treatment, shape = Rep)) +
  geom_point(stat = "identity") +
  #geom_errorbar(aes(ymin = cumulative_ugCO2_C_gdried_soil - cumulative_stdDev, ymax = cumulative_ugCO2_C_gdried_soil + cumulative_stdDev), width = 0.2) +
  labs(x = "Days", y = "Percent", title = "Cumulative Percent Substrate Respired") +
  theme_minimal()


p

ggsave(file = paste0(output_folder,"Cumulative_Percent_Substrate_Respired.pdf"), plot = p)
```


## Plot the summary_cumulative_percent_substrate_respired (Reps averaged)

```{r}
p <- ggplot(summary_C13Data_filtered, aes(x = Day, y = avg_cumulative_percent_substrate_respired, color = Treatment)) +
  geom_point(stat = "identity") +
  geom_errorbar(aes(ymin = avg_cumulative_percent_substrate_respired - cumulative_stdDev, ymax = avg_cumulative_percent_substrate_respired + cumulative_stdDev), width = 0.2) +
  labs(x = "Days", y = "Percent", title = "Average Cumulative Percent Substrate respired") +
  theme_minimal()


p

ggsave(file = paste0(output_folder,"Sumary_Cumulative_Percent_Substrate_Respired.pdf"), plot = p)
```

##Run a lmer model with cumulative_percent_13C_respired

In summary, this model is investigating how the cumulative percent 13C respired is influenced by Treatment, Day, and their interaction, while accounting for the variability between different cases (Case) by including random intercepts.

```{r}
# Be sure to define time as.factor!!!

cumulativeDataForModel <- C13Data_filtered %>%
  mutate(Day = as.factor(Day))

#Case takes 16 unique values corresponding to 16 jars!
Model <- lmer(cumulative_percent_substrate_respired ~ Treatment*Day + (1|Case), data = cumulativeDataForModel)
#Sample and Day are fixed effects
#(1|Case) specifies case (or jar) as a random effect to account for repeated measures on the same jar over time.
anova(Model)
#ANOVA table to test for main effect and interaction.  This is a common starting point.

# Run anova(Model) and capture the output
anova_output <- capture.output(anova(Model))

# Write the captured output to a text file
writeLines(anova_output, con = paste0(output_folder, "13CO2_partitioning_aov_anova.txt"))

plot(Model)
#Diagnostic plots to check assumptions of normality and equal variance.
#emmeans is VERY flexible!
emmeans_results<-emmeans(Model, pairwise ~ Treatment|Day)
emmeans_results
#The code above will compare the means for the treatments, at EACH time point.

# Capture the output of emmeans()
emmeans_output <- capture.output(summary(emmeans_results))

# Write the captured output to a text file
writeLines(emmeans_output, con = paste0(output_folder, "13CO2_partitioning_aov_emmeans.txt"))

```
